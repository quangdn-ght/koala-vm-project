#!/bin/bash

################################################################################
# FShare VM Manager - Main Entry Point
# Centralized script to manage FShare VM operations
################################################################################

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_help() {
    echo ""
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘                    FShare VM Manager                          â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "  Centralized tool for managing FShare virtual machines"
    echo ""
    
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}  USAGE${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ./fshare-vm ${YELLOW}<command>${NC} [options]"
    echo ""

    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}  VM MANAGEMENT COMMANDS${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${YELLOW}create${NC}              Create new FShare VM with Ubuntu 22.04"
    echo -e "  ${YELLOW}ssh${NC}                 SSH into the FShare VM (primary IP)"
    echo -e "  ${YELLOW}ssh2${NC}                SSH into the FShare VM (secondary IP)"
    echo -e "  ${YELLOW}start${NC}               Start the VM"
    echo -e "  ${YELLOW}stop${NC}                Stop the VM gracefully"
    echo -e "  ${YELLOW}restart${NC}             Restart the VM"
    echo -e "  ${YELLOW}destroy${NC}             Force stop the VM"
    echo -e "  ${YELLOW}status${NC}              Show VM status and info"
    echo -e "  ${YELLOW}ip${NC}                  Get VM IP addresses"
    echo -e "  ${YELLOW}console${NC}             Access VM serial console (Ctrl+] to exit)"
    echo -e "  ${YELLOW}list${NC}                List all VMs"
    echo ""

    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}  JAVA & ENVIRONMENT${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${YELLOW}java${NC}                Check Java version"
    echo -e "  ${YELLOW}maven${NC}               Check Maven version"
    echo -e "  ${YELLOW}gradle${NC}              Check Gradle version"
    echo -e "  ${YELLOW}setup-env${NC}           Run environment setup (Docker, tools)"
    echo -e "  ${YELLOW}ping${NC}                Test network connectivity"
    echo ""

    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}  BACKUP & RECOVERY${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${YELLOW}backup${NC}              Create manual backup"
    echo -e "  ${YELLOW}list-backups${NC}        List all available backups"
    echo -e "  ${YELLOW}restore${NC} <timestamp>  Show restore instructions for a backup"
    echo ""

    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}  EXAMPLES${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${YELLOW}./fshare-vm create${NC}                          Create new VM"
    echo -e "  ${YELLOW}./fshare-vm ssh${NC}                             SSH to VM (primary)"
    echo -e "  ${YELLOW}./fshare-vm ssh2${NC}                            SSH to VM (secondary)"
    echo -e "  ${YELLOW}./fshare-vm status${NC}                          Check VM status"
    echo -e "  ${YELLOW}./fshare-vm java${NC}                            Check Java version"
    echo -e "  ${YELLOW}./fshare-vm backup${NC}                          Create backup"
    echo -e "  ${YELLOW}./fshare-vm list-backups${NC}                    List all backups"
    echo -e "  ${YELLOW}./fshare-vm restore${NC} 20260105-120000         Show restore steps"
    echo ""

    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}  DOCUMENTATION${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  See ${BLUE}FSHARE-VM-GUIDE.md${NC} for detailed documentation"
    echo ""
}

create_fshare_vm() {
    # Original VM creation script content
    log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
    log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
    log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
    log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }

# VM Configuration
VM_NAME="fshare"
RAM="8192"
VCPUS="8"
DISK_SIZE="100G"
DISK_PATH="/mnt/data/${VM_NAME}.qcow2"
CLOUD_IMG="/mnt/data/vm-images/ubuntu-22.04-cloud.img"
CLOUD_INIT_DIR="/tmp/fshare-cloud-init-$$"
DEPLOY_SCRIPT_SRC="/home/ght/deploy/env/ubuntu-22.04/install-env-22.04.sh"

# Network Configuration
BRIDGE_PRIMARY="br0"
BRIDGE_SECONDARY="br1"
IP_PRIMARY="10.168.1.104"
IP_SECONDARY="192.168.3.104"

clear
echo -e "${GREEN}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                                   â•‘"
echo "â•‘     FShare VM - FULLY AUTOMATED Installation                      â•‘"
echo "â•‘     Dual Network + Java Environment                                â•‘"
echo "â•‘                                                                   â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"
echo ""
log_info "Configuration: 8 cores, 8GB RAM, 100GB storage"
log_info "OS: Ubuntu 22.04 LTS (Cloud Image)"
log_info "Network 1: $IP_PRIMARY/24 (gateway: 10.168.1.1)"
log_info "Network 2: $IP_SECONDARY/24 (no gateway)"
log_info "Java: OpenJDK 21 (Latest LTS)"
log_info "Installation: 100% automated - ready in 2-3 minutes!"
echo ""

# Check if running as non-root
if [[ $EUID -eq 0 ]]; then
    log_error "This script should NOT be run as root (don't use sudo)"
    log_info "The script will prompt for sudo password when needed"
    exit 1
fi

# Check if VM already exists
if virsh list --all | grep -q " $VM_NAME "; then
    log_warning "VM '$VM_NAME' already exists"
    read -p "Do you want to remove and recreate it? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        log_info "Removing existing VM..."
        virsh destroy "$VM_NAME" 2>/dev/null || true
        virsh undefine "$VM_NAME" --remove-all-storage 2>/dev/null || true
        sudo rm -f "$DISK_PATH"
        log_success "Removed existing VM"
    else
        log_info "Aborted"
        exit 0
    fi
fi

# Verify cloud image exists
if [ ! -f "$CLOUD_IMG" ]; then
    log_error "Cloud image not found at: $CLOUD_IMG"
    log_error "Please ensure the Ubuntu 22.04 cloud image is available at this location"
    exit 1
fi

log_info "Using cloud image: $CLOUD_IMG"

# Create VM disk from cloud image (use copy instead of backing file to avoid conflicts)
log_info "Creating VM disk (${DISK_SIZE})..."
sudo cp "$CLOUD_IMG" "$DISK_PATH"
sudo qemu-img resize "$DISK_PATH" "$DISK_SIZE"
log_success "VM disk created"

# Create cloud-init configuration
log_info "Creating cloud-init configuration..."
rm -rf "$CLOUD_INIT_DIR"
mkdir -p "$CLOUD_INIT_DIR"

# Meta-data
cat > "$CLOUD_INIT_DIR/meta-data" << EOF
instance-id: fshare-001
local-hostname: fshare
EOF

# User-data with full configuration including Java
cat > "$CLOUD_INIT_DIR/user-data" << 'EOF'
#cloud-config
hostname: fshare
fqdn: fshare.local
manage_etc_hosts: true

# Preserve SSH host keys to avoid "Remote host identification has changed" warnings
ssh_deletekeys: false
ssh_genkeytypes: ['rsa', 'ecdsa', 'ed25519']

users:
  - name: ght
    gecos: GHT User
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin, sudo
    lock_passwd: false
    passwd: $6$Qow7zg7XtSATpkJU$W6PzC8MH7153Ido7w.IopTbwD89WuHp5TIWp/Vr3HULVXwwiGQHvxQkuIQfnmanTqywxaL9u.Ftg0megvnG0L/
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCXwnKDEoJ4FuCMwHmoSOxhBOsUaeEbaIQc9BR+5z4mMOHlmPz0I3b67uJaUZGjgWmbT4W+dXw59eRmIu43rqhr41FfIaA8NDPXkcUCQmyhhCzGxFF4tJ1Ar2KK/b/1VvqbDXIh7bzkyTFGRMRif1SxYZfZm4R1+Yr3bvJz6z80QVXHI9kI5pHFRnHdE3O3kt4xVJo9HnnoMhQ6RNo4euG3rojUpFCNtq1hbuSUw7YPY9c8qpvQ8mrOAeElIkW6sfWPBZHw/AWI5r2CaGAiMYs7iP8w/bnqCcBt32GAb7kbyH/cUMjjqG3VeGgFMgERfnd9CfFHiC1XJ2lViCW7i1SatPqFcDE22HPdGbn+/2Bjym9+KA6gqa7E2eBXInvLph9Vz0v5BQbiGrbaeUuWYZ5n68i3uPiHYANmEeArDu0wnPNqFn6PvFEB0kfzG66gYZnO2AOjIa1bMyqYDxZU6BXrQRGqZpUGlTgJtbqBldzj8hikvUQH+TDWlVRnTZ2CgYMqDw792PSmhY/NGvItJTbGqLhSJYk1JR/+3ETdxSog3SI7F5pl3JmoXXilHX+DGm1d8rLQm7ogB/7lE5Pm/y9debq4vgMhQ8qXHVhzOZjHFAAz9w5qq1X7x0Kq6OGWPVx3iBIXJuyCfueEor4UsUrx8GdumBO8vViRQFd/l5wRRw== ght@ght-faceid-server

ssh_pwauth: true
disable_root: true

# Package installation - optimized for speed
apt:
  preserve_sources_list: true
  
packages:
  - qemu-guest-agent
  - openssh-server
  - curl
  - wget
  - git
  - vim
  - nano
  - net-tools
  - htop
  - iotop
  - iftop
  - netcat
  - telnet
  - dnsutils
  - build-essential
  - openjdk-21-jdk
  - openjdk-21-jre
  - maven
  - gradle

# Run commands after package installation
runcmd:
  # Enable and start qemu-guest-agent for better VM integration
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent
  
  # Create directory structure
  - mkdir -p /home/ght/deploy/env/ubuntu-22.04
  - mkdir -p /home/ght/.ssh
  - chown -R ght:ght /home/ght/deploy
  - chown -R ght:ght /home/ght/.ssh
  - chmod 700 /home/ght/.ssh
  
  # Set timezone
  - timedatectl set-timezone UTC
  
  # Configure Java environment for user
  - echo "export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64" >> /home/ght/.bashrc
  - echo "export PATH=\$JAVA_HOME/bin:\$PATH" >> /home/ght/.bashrc
  
  # Configure Java environment system-wide
  - echo "JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64" >> /etc/environment
  - update-alternatives --set java /usr/lib/jvm/java-21-openjdk-amd64/bin/java || true
  
  # Optimize SSH for faster connections
  - sed -i 's/#UseDNS yes/UseDNS no/' /etc/ssh/sshd_config
  - systemctl restart sshd
  
  # Create completion marker
  - touch /home/ght/.cloud-init-complete
  - chown ght:ght /home/ght/.cloud-init-complete

# Update and upgrade packages
package_update: true
package_upgrade: true

# Reboot after cloud-init completes to ensure all changes take effect
power_state:
  mode: reboot
  timeout: 300
  condition: true
EOF

# Network config for dual interfaces with static IPs
cat > "$CLOUD_INIT_DIR/network-config" << EOF
version: 2
ethernets:
  enp1s0:
    addresses:
      - $IP_PRIMARY/24
    routes:
      - to: 0.0.0.0/0
        via: 10.168.1.1
    nameservers:
      addresses: [8.8.8.8, 8.8.4.4]
  enp2s0:
    addresses:
      - $IP_SECONDARY/24
EOF

# Create cloud-init ISO
log_info "Creating cloud-init ISO..."
CLOUD_INIT_ISO="/tmp/fshare-cidata-$$.iso"

if command -v genisoimage &> /dev/null; then
    genisoimage -output "$CLOUD_INIT_ISO" -volid cidata -joliet -rock \
        "$CLOUD_INIT_DIR/user-data" "$CLOUD_INIT_DIR/meta-data" "$CLOUD_INIT_DIR/network-config" 2>/dev/null
else
    sudo apt-get install -y genisoimage -qq
    genisoimage -output "$CLOUD_INIT_ISO" -volid cidata -joliet -rock \
        "$CLOUD_INIT_DIR/user-data" "$CLOUD_INIT_DIR/meta-data" "$CLOUD_INIT_DIR/network-config" 2>/dev/null
fi

log_success "Cloud-init ISO created"

# Create and start VM with dual network interfaces
log_info "Creating and starting VM..."

virt-install \
    --name "$VM_NAME" \
    --virt-type kvm \
    --memory "$RAM" \
    --vcpus "$VCPUS" \
    --boot hd,menu=on \
    --disk path="$DISK_PATH",device=disk,bus=virtio \
    --disk path="$CLOUD_INIT_ISO",device=cdrom \
    --os-variant ubuntu22.04 \
    --network bridge="$BRIDGE_PRIMARY",model=virtio \
    --network bridge="$BRIDGE_SECONDARY",model=virtio \
    --graphics none \
    --console pty,target_type=serial \
    --noautoconsole \
    --import

sleep 5

log_success "VM created and started!"

# Wait for VM to boot and configure (cloud-init takes ~2 minutes)
log_info "Waiting for VM to boot and configure (this takes ~2-3 minutes)..."
echo ""

VM_READY=false
for i in {1..40}; do
    if ping -c 1 -W 2 "$IP_PRIMARY" > /dev/null 2>&1; then
        VM_READY=true
        echo ""
        log_success "Primary network interface is up: $IP_PRIMARY"
        break
    fi
    echo -n "."
    sleep 5
done

echo ""

if [ "$VM_READY" = false ]; then
    log_warning "Primary IP not responding yet. Network may still be configuring."
    log_info "Wait a few minutes and try: ssh ght@$IP_PRIMARY"
fi

# Wait for SSH to be ready
if [ "$VM_READY" = true ]; then
    log_info "Waiting for SSH service to be ready..."
    SSH_READY=false
    
    for i in {1..30}; do
        if timeout 3 ssh -o ConnectTimeout=2 -o StrictHostKeyChecking=no -o BatchMode=yes ght@$IP_PRIMARY exit 2>/dev/null; then
            SSH_READY=true
            break
        fi
        echo -n "."
        sleep 5
    done
    
    echo ""
    
    if [ "$SSH_READY" = true ]; then
        log_success "SSH is ready!"
        
        # Test secondary interface
        log_info "Testing secondary network interface..."
        if ping -c 1 -W 2 "$IP_SECONDARY" > /dev/null 2>&1; then
            log_success "Secondary IP is reachable: $IP_SECONDARY"
        else
            log_warning "Secondary IP not yet reachable (may need a moment)"
        fi
        
        # Transfer environment setup script
        log_info "Transferring environment setup script..."
        
        if scp -o StrictHostKeyChecking=no "$DEPLOY_SCRIPT_SRC" ght@$IP_PRIMARY:/home/ght/deploy/env/ubuntu-22.04/ 2>/dev/null; then
            log_success "Environment setup script transferred"
            
            log_info "Making script executable..."
            ssh -o StrictHostKeyChecking=no ght@$IP_PRIMARY "chmod +x /home/ght/deploy/env/ubuntu-22.04/install-env-22.04.sh" 2>/dev/null
            
            log_success "Environment setup script is ready"
        else
            log_warning "Could not transfer script automatically"
            log_info "You can transfer it manually after VM is ready"
        fi
    else
        log_warning "SSH not responding yet. Wait a minute and try: ssh ght@$IP_PRIMARY"
    fi
fi

# Cleanup
rm -rf "$CLOUD_INIT_DIR"

# Display summary
echo ""
log_success "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
log_success "â•‘     FShare VM Created Successfully - 100% Automated!       â•‘"
log_success "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
log_info "VM Details:"
echo "  â€¢ Name:        $VM_NAME"
echo "  â€¢ CPU:         $VCPUS cores"
echo "  â€¢ RAM:         8GB"
echo "  â€¢ Disk:        $DISK_SIZE (in /mnt/data)"
echo "  â€¢ Primary IP:  $IP_PRIMARY (gateway: 10.168.1.1)"
echo "  â€¢ Secondary IP: $IP_SECONDARY (no gateway)"
echo "  â€¢ Username:    ght"
echo "  â€¢ Password:    1"
echo "  â€¢ SSH Key:     Configured (passwordless)"
echo ""
log_info "Java Environment:"
echo "  â€¢ Version:     OpenJDK 21 (Latest LTS)"
echo "  â€¢ JAVA_HOME:   /usr/lib/jvm/java-21-openjdk-amd64"
echo "  â€¢ Verify:      ssh ght@$IP_PRIMARY 'java -version'"
echo ""
log_info "Access VM:"
echo "  â€¢ Primary:     ssh ght@$IP_PRIMARY"
echo "  â€¢ Secondary:   ssh ght@$IP_SECONDARY"
echo ""
log_info "Network Verification:"
echo "  â€¢ Test primary:   ping $IP_PRIMARY"
echo "  â€¢ Test secondary: ping $IP_SECONDARY"
echo "  â€¢ Check routes:   ssh ght@$IP_PRIMARY 'ip route'"
echo "  â€¢ Check IPs:      ssh ght@$IP_PRIMARY 'ip addr'"
echo ""
log_info "Next Steps:"
echo "  1. Run environment setup script (Docker, tools, etc):"
echo "     ssh ght@$IP_PRIMARY"
echo "     cd deploy/env/ubuntu-22.04"
echo "     ./install-env-22.04.sh"
echo ""
echo "  2. Verify Java installation:"
echo "     ssh ght@$IP_PRIMARY 'java -version'"
echo ""
log_info "VM Management:"
echo "  â€¢ Use CLI:     ./fshare-vm [command]"
echo "  â€¢ Status:      ./fshare-vm status"
echo "  â€¢ Start:       ./fshare-vm start"
echo "  â€¢ Stop:        ./fshare-vm stop"
echo "  â€¢ Console:     ./fshare-vm console"
echo ""
log_success "Installation complete! ğŸš€"
}

# Main command router
VM_NAME="fshare"
IP_PRIMARY="10.168.1.104"
IP_SECONDARY="192.168.3.104"

case "${1:-}" in
    create)
        create_fshare_vm "${@:2}"
        ;;
    ssh)
        echo -e "${GREEN}Connecting to FShare VM (primary IP: $IP_PRIMARY)...${NC}"
        ssh ght@"$IP_PRIMARY"
        ;;
    ssh2)
        echo -e "${GREEN}Connecting to FShare VM (secondary IP: $IP_SECONDARY)...${NC}"
        ssh ght@"$IP_SECONDARY"
        ;;
    start)
        virsh start "$VM_NAME"
        echo -e "${GREEN}VM started${NC}"
        ;;
    stop)
        virsh shutdown "$VM_NAME"
        echo -e "${GREEN}VM shutdown initiated${NC}"
        ;;
    restart)
        virsh destroy "$VM_NAME" 2>/dev/null || true
        sleep 2
        virsh start "$VM_NAME"
        echo -e "${GREEN}VM restarted${NC}"
        ;;
    destroy)
        virsh destroy "$VM_NAME"
        echo -e "${GREEN}VM force stopped${NC}"
        ;;
    status)
        virsh dominfo "$VM_NAME"
        ;;
    ip)
        echo "VM IP Addresses:"
        echo -e "  Primary:   ${GREEN}$IP_PRIMARY${NC} (gateway: 10.168.1.1)"
        echo -e "  Secondary: ${GREEN}$IP_SECONDARY${NC} (no gateway)"
        echo ""
        echo -e "${BLUE}Testing connectivity...${NC}"
        if ping -c 1 -W 2 "$IP_PRIMARY" > /dev/null 2>&1; then
            echo -e "  Primary:   ${GREEN}âœ“ reachable${NC}"
        else
            echo -e "  Primary:   ${RED}âœ— not reachable${NC}"
        fi
        
        if ping -c 1 -W 2 "$IP_SECONDARY" > /dev/null 2>&1; then
            echo -e "  Secondary: ${GREEN}âœ“ reachable${NC}"
        else
            echo -e "  Secondary: ${RED}âœ— not reachable${NC}"
        fi
        ;;
    console)
        echo ""
        echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${YELLOW}â•‘  Accessing VM Serial Console                    â•‘${NC}"
        echo -e "${YELLOW}â•‘  Press ${RED}Ctrl+]${YELLOW} to exit console                   â•‘${NC}"
        echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        sleep 2
        virsh console "$VM_NAME"
        ;;
    list)
        virsh list --all
        ;;
    java)
        echo -e "${GREEN}Checking Java version...${NC}"
        ssh -o ConnectTimeout=5 ght@"$IP_PRIMARY" 'java -version'
        ;;
    maven)
        echo -e "${GREEN}Checking Maven version...${NC}"
        ssh -o ConnectTimeout=5 ght@"$IP_PRIMARY" 'mvn --version'
        ;;
    gradle)
        echo -e "${GREEN}Checking Gradle version...${NC}"
        ssh -o ConnectTimeout=5 ght@"$IP_PRIMARY" 'gradle --version'
        ;;
    setup-env)
        echo -e "${GREEN}Running environment setup script...${NC}"
        ssh -o ConnectTimeout=5 -t ght@"$IP_PRIMARY" 'cd deploy/env/ubuntu-22.04 && ./install-env-22.04.sh'
        ;;
    ping)
        echo "Testing network connectivity..."
        echo -n "Primary IP ($IP_PRIMARY): "
        if ping -c 3 -W 2 "$IP_PRIMARY" > /dev/null 2>&1; then
            echo -e "${GREEN}âœ“ OK${NC}"
        else
            echo -e "${RED}âœ— FAILED${NC}"
        fi
        
        echo -n "Secondary IP ($IP_SECONDARY): "
        if ping -c 3 -W 2 "$IP_SECONDARY" > /dev/null 2>&1; then
            echo -e "${GREEN}âœ“ OK${NC}"
        else
            echo -e "${RED}âœ— FAILED${NC}"
        fi
        ;;
    backup)
        sudo "$SCRIPT_DIR/scripts/helpers/backup-fshare-vm.sh"
        ;;
    list-backups)
        echo -e "${GREEN}Available backups in /mnt/data/snapshot:${NC}"
        if [ -d /mnt/data/snapshot ]; then
            cd /mnt/data/snapshot
            ls -lth fshare-backup-*.qcow2 2>/dev/null | head -20
            ls -lth fshare-backup-*.xml 2>/dev/null | head -20
            if [ $? -ne 0 ]; then
                echo -e "${YELLOW}No backups found${NC}"
            fi
        else
            echo -e "${RED}Backup directory not found: /mnt/data/snapshot${NC}"
        fi
        ;;
    restore)
        if [ -z "${2:-}" ]; then
            echo -e "${RED}Error: Backup timestamp required${NC}"
            echo "Usage: ./fshare-vm restore <backup-timestamp>"
            echo "Example: ./fshare-vm restore 20260105-120000"
            echo ""
            echo -e "${GREEN}Available backups:${NC}"
            ls -1 /mnt/data/snapshot/fshare-backup-*.qcow2 2>/dev/null | sed 's/.*fshare-backup-\(.*\)\.qcow2/\1/' || echo -e "${YELLOW}No backups found${NC}"
            exit 1
        fi
        
        BACKUP_TIMESTAMP="$2"
        BACKUP_DISK="/mnt/data/snapshot/fshare-backup-${BACKUP_TIMESTAMP}.qcow2"
        BACKUP_XML="/mnt/data/snapshot/fshare-backup-${BACKUP_TIMESTAMP}.xml"
        
        if [ ! -f "$BACKUP_DISK" ] || [ ! -f "$BACKUP_XML" ]; then
            echo -e "${RED}Error: Backup not found for timestamp: $BACKUP_TIMESTAMP${NC}"
            echo "Looking for: $BACKUP_DISK"
            exit 1
        fi
        
        echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${YELLOW}â•‘  Restore Instructions for backup: $BACKUP_TIMESTAMP         â•‘${NC}"
        echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo -e "${GREEN}Backup files found:${NC}"
        echo -e "  Disk:   $BACKUP_DISK"
        echo -e "  Config: $BACKUP_XML"
        echo ""
        echo -e "${RED}âš ï¸  WARNING: This will replace your current VM! âš ï¸${NC}"
        echo ""
        echo -e "${GREEN}Method 1: Quick Restore (Replace Current VM)${NC}"
        echo "----------------------------------------"
        echo "# Stop the running VM"
        echo "sudo virsh destroy $VM_NAME"
        echo ""
        echo "# Backup current disk (optional)"
        echo "sudo mv /mnt/data/$VM_NAME.qcow2 /mnt/data/$VM_NAME.qcow2.old"
        echo ""
        echo "# Restore the backup disk"
        echo "sudo cp $BACKUP_DISK /mnt/data/$VM_NAME.qcow2"
        echo ""
        echo "# Start the VM"
        echo "sudo virsh start $VM_NAME"
        echo ""
        echo -e "${YELLOW}After successful restore, verify with:${NC}"
        echo "  ./fshare-vm status"
        echo "  ./fshare-vm ip"
        echo "  ./fshare-vm ssh"
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo -e "${RED}Error: Unknown command '${1}'${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac

