#### Preseed Configuration for Automated Ubuntu 22.04 Installation - FShare VM
#### Full disk automatic installation with dual network interfaces and Java

### Localization
d-i debian-installer/locale string en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select us
d-i console-setup/ask_detect boolean false

### Network configuration - Primary interface
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string fshare
d-i netcfg/get_domain string local
d-i netcfg/wireless_wep string

### Mirror settings
d-i mirror/country string manual
d-i mirror/http/hostname string archive.ubuntu.com
d-i mirror/http/directory string /ubuntu
d-i mirror/http/proxy string

### Clock and time zone setup
d-i clock-setup/utc boolean true
d-i time/zone string UTC
d-i clock-setup/ntp boolean true

### Partitioning - Use entire disk automatically
d-i partman-auto/method string regular
d-i partman-auto/choose_recipe select atomic
d-i partman-auto/disk string /dev/vda
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true
d-i partman-auto/purge_lvm_from_device boolean true
d-i partman-auto-lvm/guided_size string max
d-i partman-auto-lvm/new_vg_name string vg00
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true
d-i partman-partitioning/confirm_write_new_label boolean true

### Account setup
d-i passwd/root-login boolean false
d-i passwd/user-fullname string GHT User
d-i passwd/username string ght
# Password: "1" (encrypted with SHA-512)
d-i passwd/user-password-crypted password $6$Qow7zg7XtSATpkJU$W6PzC8MH7153Ido7w.IopTbwD89WuHp5TIWp/Vr3HULVXwwiGQHvxQkuIQfnmanTqywxaL9u.Ftg0megvnG0L/
d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false

### Base system installation
d-i base-installer/install-recommends boolean true
d-i base-installer/kernel/image string linux-generic

### Package selection - Include Java and development tools
tasksel tasksel/first multiselect standard, server
d-i pkgsel/include string openssh-server vim curl wget net-tools git openjdk-21-jdk openjdk-21-jre build-essential
d-i pkgsel/upgrade select full-upgrade
d-i pkgsel/update-policy select none
d-i pkgsel/updatedb boolean true

### Boot loader installation
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
d-i grub-installer/bootdev string /dev/vda

### Finishing up the installation
d-i finish-install/reboot_in_progress note
d-i debian-installer/exit/poweroff boolean false

### Custom commands
# Configure dual network interfaces, Java, SSH key, sudo, and deploy scripts
d-i preseed/late_command string \
    in-target sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"/GRUB_CMDLINE_LINUX_DEFAULT="console=tty0 console=ttyS0,115200n8"/' /etc/default/grub ; \
    in-target update-grub ; \
    in-target systemctl enable serial-getty@ttyS0.service ; \
    in-target apt-get update ; \
    in-target apt-get install -y qemu-guest-agent || true ; \
    in-target mkdir -p /home/ght/.ssh ; \
    in-target sh -c 'echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCXwnKDEoJ4FuCMwHmoSOxhBOsUaeEbaIQc9BR+5z4mMOHlmPz0I3b67uJaUZGjgWmbT4W+dXw59eRmIu43rqhr41FfIaA8NDPXkcUCQmyhhCzGxFF4tJ1Ar2KK/b/1VvqbDXIh7bzkyTFGRMRif1SxYZfZm4R1+Yr3bvJz6z80QVXHI9kI5pHFRnHdE3O3kt4xVJo9HnnoMhQ6RNo4euG3rojUpFCNtq1hbuSUw7YPY9c8qpvQ8mrOAeElIkW6sfWPBZHw/AWI5r2CaGAiMYs7iP8w/bnqCcBt32GAb7kbyH/cUMjjqG3VeGgFMgERfnd9CfFHiC1XJ2lViCW7i1SatPqFcDE22HPdGbn+/2Bjym9+KA6gqa7E2eBXInvLph9Vz0v5BQbiGrbaeUuWYZ5n68i3uPiHYANmEeArDu0wnPNqFn6PvFEB0kfzG66gYZnO2AOjIa1bMyqYDxZU6BXrQRGqZpUGlTgJtbqBldzj8hikvUQH+TDWlVRnTZ2CgYMqDw792PSmhY/NGvItJTbGqLhSJYk1JR/+3ETdxSog3SI7F5pl3JmoXXilHX+DGm1d8rLQm7ogB/7lE5Pm/y9debq4vgMhQ8qXHVhzOZjHFAAz9w5qq1X7x0Kq6OGWPVx3iBIXJuyCfueEor4UsUrx8GdumBO8vViRQFd/l5wRRw== ght@ght-faceid-server" > /home/ght/.ssh/authorized_keys' ; \
    in-target chown -R ght:ght /home/ght/.ssh ; \
    in-target chmod 700 /home/ght/.ssh ; \
    in-target chmod 600 /home/ght/.ssh/authorized_keys ; \
    in-target usermod -aG sudo ght ; \
    in-target sh -c 'echo "ght ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/ght' ; \
    in-target chmod 440 /etc/sudoers.d/ght ; \
    in-target mkdir -p /home/ght/deploy/env/ubuntu-22.04 ; \
    in-target chown -R ght:ght /home/ght/deploy ; \
    in-target sh -c 'cat > /etc/netplan/00-installer-config.yaml << "NETPLAN"\nnetwork:\n  version: 2\n  ethernets:\n    enp1s0:\n      addresses:\n        - 10.168.1.104/24\n      routes:\n        - to: 0.0.0.0/0\n          via: 10.168.1.1\n      nameservers:\n        addresses: [8.8.8.8, 8.8.4.4]\n    enp2s0:\n      addresses:\n        - 192.168.3.104/24\nNETPLAN\n' ; \
    in-target chmod 600 /etc/netplan/00-installer-config.yaml ; \
    in-target sh -c 'echo "export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64" >> /home/ght/.bashrc' ; \
    in-target sh -c 'echo "export PATH=\$JAVA_HOME/bin:\$PATH" >> /home/ght/.bashrc' ; \
    in-target sh -c 'echo "export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64" >> /etc/environment' ; \
    in-target update-alternatives --set java /usr/lib/jvm/java-21-openjdk-amd64/bin/java || true ; \
    in-target mkdir -p /tmp/deploy-transfer

