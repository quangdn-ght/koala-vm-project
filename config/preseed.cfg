#### Preseed Configuration for Automated Ubuntu 16.04 Installation
#### Full disk automatic installation without user prompts

### Localization
d-i debian-installer/locale string en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select us
d-i console-setup/ask_detect boolean false

### Network configuration
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string faceid
d-i netcfg/get_domain string local
d-i netcfg/wireless_wep string

### Mirror settings
d-i mirror/country string manual
d-i mirror/http/hostname string archive.ubuntu.com
d-i mirror/http/directory string /ubuntu
d-i mirror/http/proxy string

### Clock and time zone setup
d-i clock-setup/utc boolean true
d-i time/zone string UTC
d-i clock-setup/ntp boolean true

### Partitioning - Use entire disk automatically
d-i partman-auto/method string regular
d-i partman-auto/choose_recipe select atomic
d-i partman-auto/disk string /dev/vda
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true
d-i partman-auto/purge_lvm_from_device boolean true
d-i partman-auto-lvm/guided_size string max
d-i partman-auto-lvm/new_vg_name string vg00
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true
d-i partman-partitioning/confirm_write_new_label boolean true

### Account setup
d-i passwd/root-login boolean false
d-i passwd/user-fullname string Koala User
d-i passwd/username string koala
# Password: 1 (encrypted)
d-i passwd/user-password-crypted password $6$Qow7zg7XtSATpkJU$W6PzC8MH7153Ido7w.IopTbwD89WuHp5TIWp/Vr3HULVXwwiGQHvxQkuIQfnmanTqywxaL9u.Ftg0megvnG0L/
d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false

### Base system installation
d-i base-installer/install-recommends boolean true
d-i base-installer/kernel/image string linux-generic

### Package selection
tasksel tasksel/first multiselect standard, server
d-i pkgsel/include string openssh-server vim curl wget net-tools supervisor
d-i pkgsel/upgrade select full-upgrade
d-i pkgsel/update-policy select none
d-i pkgsel/updatedb boolean true

### Boot loader installation
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
d-i grub-installer/bootdev string /dev/vda

### Finishing up the installation
d-i finish-install/reboot_in_progress note
d-i debian-installer/exit/poweroff boolean false

### Custom commands
# Enable serial console, install additional packages, setup SSH key, and install Docker
d-i preseed/late_command string \
    in-target sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"/GRUB_CMDLINE_LINUX_DEFAULT="console=tty0 console=ttyS0,115200n8"/' /etc/default/grub ; \
    in-target update-grub ; \
    in-target systemctl enable serial-getty@ttyS0.service ; \
    in-target apt-get update ; \
    in-target apt-get install -y open-vm-tools || true ; \
    in-target mkdir -p /home/koala/.ssh ; \
    in-target sh -c 'echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCXwnKDEoJ4FuCMwHmoSOxhBOsUaeEbaIQc9BR+5z4mMOHlmPz0I3b67uJaUZGjgWmbT4W+dXw59eRmIu43rqhr41FfIaA8NDPXkcUCQmyhhCzGxFF4tJ1Ar2KK/b/1VvqbDXIh7bzkyTFGRMRif1SxYZfZm4R1+Yr3bvJz6z80QVXHI9kI5pHFRnHdE3O3kt4xVJo9HnnoMhQ6RNo4euG3rojUpFCNtq1hbuSUw7YPY9c8qpvQ8mrOAeElIkW6sfWPBZHw/AWI5r2CaGAiMYs7iP8w/bnqCcBt32GAb7kbyH/cUMjjqG3VeGgFMgERfnd9CfFHiC1XJ2lViCW7i1SatPqFcDE22HPdGbn+/2Bjym9+KA6gqa7E2eBXInvLph9Vz0v5BQbiGrbaeUuWYZ5n68i3uPiHYANmEeArDu0wnPNqFn6PvFEB0kfzG66gYZnO2AOjIa1bMyqYDxZU6BXrQRGqZpUGlTgJtbqBldzj8hikvUQH+TDWlVRnTZ2CgYMqDw792PSmhY/NGvItJTbGqLhSJYk1JR/+3ETdxSog3SI7F5pl3JmoXXilHX+DGm1d8rLQm7ogB/7lE5Pm/y9debq4vgMhQ8qXHVhzOZjHFAAz9w5qq1X7x0Kq6OGWPVx3iBIXJuyCfueEor4UsUrx8GdumBO8vViRQFd/l5wRRw== ght@ght-faceid-server" > /home/koala/.ssh/authorized_keys' ; \
    in-target chown -R koala:koala /home/koala/.ssh ; \
    in-target chmod 700 /home/koala/.ssh ; \
    in-target chmod 600 /home/koala/.ssh/authorized_keys ; \
    in-target usermod -aG sudo koala ; \
    in-target sh -c 'echo "koala ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/koala' ; \
    in-target chmod 440 /etc/sudoers.d/koala ; \
    in-target sh -c 'cat > /etc/apt/sources.list << "SOURCES_EOF"\n# Ubuntu 16.04 LTS (Xenial Xerus) - Universal Sources List\n\n# Main repositories\ndeb http://archive.ubuntu.com/ubuntu xenial main restricted universe multiverse\ndeb-src http://archive.ubuntu.com/ubuntu xenial main restricted universe multiverse\n\n# Updates repositories\ndeb http://archive.ubuntu.com/ubuntu xenial-updates main restricted universe multiverse\ndeb-src http://archive.ubuntu.com/ubuntu xenial-updates main restricted universe multiverse\n\n# Backports repositories\ndeb http://archive.ubuntu.com/ubuntu xenial-backports main restricted universe multiverse\ndeb-src http://archive.ubuntu.com/ubuntu xenial-backports main restricted universe multiverse\n\n# Security repositories\ndeb http://security.ubuntu.com/ubuntu xenial-security main restricted universe multiverse\ndeb-src http://security.ubuntu.com/ubuntu xenial-security main restricted universe multiverse\nSOURCES_EOF\n' ; \
    in-target mkdir -p /tmp/docker-install ; \
    in-target sh -c 'curl -fsSL https://get.docker.com -o /tmp/docker-install/get-docker.sh' ; \
    in-target sh -c 'sh /tmp/docker-install/get-docker.sh' ; \
    in-target usermod -aG docker koala ; \
    in-target systemctl enable docker ; \
    in-target sh -c 'curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose' ; \
    in-target chmod +x /usr/local/bin/docker-compose ; \
    in-target ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose ; \
    in-target mkdir -p /etc/docker ; \
    in-target sh -c 'cat > /etc/docker/daemon.json << "DOCKER_EOF"\n{\n  "log-driver": "json-file",\n  "log-opts": {\n    "max-size": "10m",\n    "max-file": "3"\n  },\n  "storage-driver": "overlay2"\n}\nDOCKER_EOF\n' ; \
    in-target systemctl restart docker || true ; \
    in-target rm -rf /tmp/docker-install
